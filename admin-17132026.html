<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>CellarSense Admin | Wedding Wine Guide Generator</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wine-burgundy: #722f37;
            --wine-cream: #f5f0eb;
            --wine-gold: #c9a227;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a6e;
            --text-light: #8a8a9e;
            --white: #ffffff;
            --shadow-soft: 0 4px 20px rgba(26, 26, 46, 0.08);
            --shadow-medium: 0 8px 40px rgba(26, 26, 46, 0.12);
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--wine-cream);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        h1, h2, h3, h4 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-weight: 600;
        }

        .header {
            background: var(--wine-burgundy);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .card-title {
            font-size: 1.25rem;
            color: var(--wine-burgundy);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--wine-cream);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--wine-burgundy);
            box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: var(--wine-burgundy);
            color: white;
        }

        .btn-primary:hover {
            background: #5a252c;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .quantity-display {
            background: var(--wine-cream);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .quantity-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .quantity-item {
            background: white;
            padding: 1rem 0.5rem;
            border-radius: var(--radius-md);
        }

        .quantity-item.total {
            background: var(--wine-burgundy);
            color: white;
        }

        .quantity-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .quantity-item.total .quantity-label {
            color: rgba(255,255,255,0.7);
        }

        .quantity-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--wine-burgundy);
            margin-top: 0.25rem;
        }

        .quantity-item.total .quantity-value {
            color: white;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1.5rem;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--wine-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        .loading-subtext {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        /* Error message */
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Success message */
        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .help-text {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .quantity-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>CellarSense Admin</h1>
        <p>Wedding Wine Guide Generator</p>
    </header>

    <div class="container">
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <!-- Client Details -->
        <div class="card">
            <h2 class="card-title">üìã Client Details</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="names">Couple's Names</label>
                    <input type="text" id="names" placeholder="Sarah & Michael">
                </div>
                <div class="form-group">
                    <label for="date">Wedding Date</label>
                    <input type="date" id="date">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="venue">Venue Name</label>
                    <input type="text" id="venue" placeholder="Rosewood Estate">
                </div>
                <div class="form-group">
                    <label for="venueType">Venue Type</label>
                    <select id="venueType">
                        <option value="">Select...</option>
                        <option value="Vineyard">Vineyard</option>
                        <option value="Beach">Beach</option>
                        <option value="Barn/Rustic">Barn/Rustic</option>
                        <option value="Garden">Garden</option>
                        <option value="Hotel/Ballroom">Hotel/Ballroom</option>
                        <option value="Restaurant">Restaurant</option>
                        <option value="Winery">Winery</option>
                        <option value="Estate/Manor">Estate/Manor</option>
                        <option value="Rooftop">Rooftop</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="guests">Guest Count</label>
                    <input type="number" id="guests" placeholder="120" min="10" max="500" oninput="updateQuantityCalc()">
                </div>
                <div class="form-group">
                    <label for="hours">Reception Hours</label>
                    <input type="number" id="hours" placeholder="5" min="1" max="10" oninput="updateQuantityCalc()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="budget">Wine Budget ($)</label>
                    <input type="number" id="budget" placeholder="2000" min="100" oninput="updateQuantityCalc()">
                </div>
                <div class="form-group">
                    <label for="location">Location (City, State)</label>
                    <input type="text" id="location" placeholder="Tampa, FL">
                    <p class="help-text">Used for local wine shop recommendations</p>
                </div>
            </div>
        </div>

        <!-- Bar Setup -->
        <div class="card">
            <h2 class="card-title">üç∑ Bar Setup</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="barType">Bar Style</label>
                    <select id="barType" onchange="updateQuantityCalc()">
                        <option value="wine-focus">Wine-Focused</option>
                        <option value="mixed" selected>Mixed Bar (Wine + Full Bar)</option>
                        <option value="wine-beer">Wine & Beer Only</option>
                        <option value="toast-only">Toast Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="drinkingLevel">Drinking Level</label>
                    <select id="drinkingLevel" onchange="updateQuantityCalc()">
                        <option value="light">Light (0.3 drinks/guest)</option>
                        <option value="moderate" selected>Moderate (0.5 drinks/guest)</option>
                        <option value="heavy">Heavy (0.7 drinks/guest)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="redWhiteBalance">Red/White Balance</label>
                    <select id="redWhiteBalance" onchange="updateQuantityCalc()">
                        <option value="balanced" selected>Balanced (50/50)</option>
                        <option value="more-red">More Red (60/40)</option>
                        <option value="more-white">More White (40/60)</option>
                        <option value="heavy-red">Heavy Red (75/25)</option>
                        <option value="heavy-white">Heavy White (25/75)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sparklingUsage">Sparkling Wine</label>
                    <select id="sparklingUsage" onchange="updateQuantityCalc()">
                        <option value="toast-only" selected>Toast Only</option>
                        <option value="toast-and-bar">Toast + Bar Service</option>
                        <option value="no-toast">No Toast (Bar Only)</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="includeRose" onchange="updateQuantityCalc()" style="width: auto;">
                <label for="includeRose" style="margin: 0;">Include Ros√©</label>
            </div>

            <!-- Quantity Calculator -->
            <div class="quantity-display">
                <label style="margin-bottom: 1rem; display: block;">Estimated Quantities</label>
                <div class="quantity-grid">
                    <div class="quantity-item">
                        <div class="quantity-label">Sparkling</div>
                        <div class="quantity-value" id="qty-sparkling">0</div>
                    </div>
                    <div class="quantity-item">
                        <div class="quantity-label">White</div>
                        <div class="quantity-value" id="qty-white">0</div>
                    </div>
                    <div class="quantity-item">
                        <div class="quantity-label">Red</div>
                        <div class="quantity-value" id="qty-red">0</div>
                    </div>
                    <div class="quantity-item">
                        <div class="quantity-label">Ros√©</div>
                        <div class="quantity-value" id="qty-rose">0</div>
                    </div>
                    <div class="quantity-item total">
                        <div class="quantity-label">Total</div>
                        <div class="quantity-value" id="qty-total">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personalization -->
        <div class="card">
            <h2 class="card-title">‚ú® Personalization</h2>
            
            <div class="form-group">
                <label for="vibe">Wedding Theme/Vibe</label>
                <input type="text" id="vibe" placeholder="Mediterranean-inspired, elegant but approachable">
                <p class="help-text">Keywords: romantic, rustic, modern, garden, bohemian, classic, etc.</p>
            </div>

            <div class="form-group">
                <label for="food">Food Menu</label>
                <textarea id="food" placeholder="Cocktail hour: oysters, crab cakes, cheese board
Dinner: beef tenderloin, grilled salmon, pasta primavera"></textarea>
            </div>

            <div class="form-group">
                <label for="preferences">Client Preferences</label>
                <textarea id="preferences" placeholder="Sarah loves crisp whites, Michael prefers bold reds
They both enjoy Italian wines"></textarea>
            </div>

            <div class="form-group">
                <label for="notes">Special Notes from Consultation</label>
                <textarea id="notes" placeholder="Michael's grandmother is Italian - want to honor that heritage
They visited Napa on their first vacation together
Want wines that photograph well"></textarea>
                <p class="help-text">These notes will be woven into the personal letter</p>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="card">
            <button class="btn btn-primary" onclick="generatePDF()" id="generate-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Generate Wine Guide PDF
            </button>
            <p class="help-text" style="text-align: center; margin-top: 1rem;">
                AI will generate personalized wine recommendations, a custom letter, and create an 8-page PDF guide.
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Generating your wine guide...</div>
        <div class="loading-subtext">AI is selecting wines and writing personalized content</div>
    </div>

    <script>
        // ============================================
        // QUANTITY CALCULATOR
        // ============================================
        function updateQuantityCalc() {
            const guests = parseInt(document.getElementById('guests').value) || 0;
            const hours = parseFloat(document.getElementById('hours').value) || 5;
            const barType = document.getElementById('barType').value;
            const drinkingLevel = document.getElementById('drinkingLevel').value;
            const redWhiteBalance = document.getElementById('redWhiteBalance').value;
            const sparklingUsage = document.getElementById('sparklingUsage').value;
            const includeRose = document.getElementById('includeRose').checked;

            if (guests === 0) {
                document.getElementById('qty-sparkling').textContent = '0';
                document.getElementById('qty-white').textContent = '0';
                document.getElementById('qty-red').textContent = '0';
                document.getElementById('qty-rose').textContent = '0';
                document.getElementById('qty-total').textContent = '0';
                return;
            }

            // Drinking level: glasses per guest per hour
            const drinkingRates = { light: 0.75, moderate: 1.0, heavy: 1.5 };
            const glassesPerGuestPerHour = drinkingRates[drinkingLevel];

            // Bar type: what % of drinks are wine
            const winePercentages = { 
                'wine-focus': 0.85,  // Most people drinking wine
                'wine-beer': 0.60,   // Wine and beer split
                'mixed': 0.40,       // Full bar, wine is one option
                'toast-only': 0.10   // Just toast, minimal wine
            };
            const winePercentage = winePercentages[barType];

            // Total wine glasses needed (excluding toast sparkling)
            const totalWineGlasses = guests * hours * glassesPerGuestPerHour * winePercentage;
            
            // Convert to bottles (5 glasses per bottle)
            let totalStillWineBottles = Math.ceil(totalWineGlasses / 5);

            // Sparkling calculation (separate from still wine)
            let sparklingBottles;
            if (sparklingUsage === 'toast-only') {
                // Just for toast: 1 glass per guest, 6 glasses per bottle
                sparklingBottles = Math.ceil(guests / 6);
            } else if (sparklingUsage === 'toast-and-bar') {
                // Toast + some for bar service
                sparklingBottles = Math.ceil(guests / 6) + Math.ceil(guests / 15);
            } else {
                // No toast, just bar availability
                sparklingBottles = Math.ceil(guests / 12);
            }

            // Ros√© allocation (from still wine pool)
            let roseBottles = 0;
            if (includeRose) {
                roseBottles = Math.ceil(totalStillWineBottles * 0.15);
                totalStillWineBottles = totalStillWineBottles - roseBottles;
            }

            // Red/White split (from remaining still wine)
            const balanceSplits = {
                'balanced': { red: 0.5, white: 0.5 },
                'more-red': { red: 0.6, white: 0.4 },
                'more-white': { red: 0.4, white: 0.6 },
                'heavy-red': { red: 0.75, white: 0.25 },
                'heavy-white': { red: 0.25, white: 0.75 }
            };
            const split = balanceSplits[redWhiteBalance];

            const redBottles = Math.ceil(totalStillWineBottles * split.red);
            const whiteBottles = Math.ceil(totalStillWineBottles * split.white);

            const total = sparklingBottles + whiteBottles + redBottles + roseBottles;

            document.getElementById('qty-sparkling').textContent = sparklingBottles;
            document.getElementById('qty-white').textContent = whiteBottles;
            document.getElementById('qty-red').textContent = redBottles;
            document.getElementById('qty-rose').textContent = roseBottles;
            document.getElementById('qty-total').textContent = total;
        }

        // ============================================
        // GENERATE PDF
        // ============================================
        async function generatePDF() {
            // Collect form data
            const data = {
                names: document.getElementById('names').value.trim(),
                date: document.getElementById('date').value,
                venue: document.getElementById('venue').value.trim(),
                venueType: document.getElementById('venueType').value,
                guests: parseInt(document.getElementById('guests').value) || 0,
                hours: parseInt(document.getElementById('hours').value) || 5,
                budget: parseInt(document.getElementById('budget').value) || 0,
                location: document.getElementById('location').value.trim(),
                barType: document.getElementById('barType').value,
                drinkingLevel: document.getElementById('drinkingLevel').value,
                redWhiteBalance: document.getElementById('redWhiteBalance').value,
                sparklingUsage: document.getElementById('sparklingUsage').value,
                includeRose: document.getElementById('includeRose').checked,
                vibe: document.getElementById('vibe').value.trim(),
                food: document.getElementById('food').value.trim(),
                preferences: document.getElementById('preferences').value.trim(),
                notes: document.getElementById('notes').value.trim()
            };

            // Validation
            if (!data.names) {
                showError("Please enter the couple's names");
                return;
            }
            if (!data.guests || data.guests < 10) {
                showError("Please enter a valid guest count (minimum 10)");
                return;
            }
            if (!data.budget || data.budget < 100) {
                showError("Please enter a valid budget (minimum $100)");
                return;
            }

            // Show loading
            document.getElementById('loading-overlay').classList.add('active');
            document.getElementById('generate-btn').disabled = true;
            hideError();
            hideSuccess();

            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate PDF');
                }

                // Get the PDF blob
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.names.replace(/[^a-z0-9]/gi, '_')}_Wine_Guide.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                showSuccess('PDF generated successfully! Check your downloads.');

            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to generate PDF. Please try again.');
            } finally {
                document.getElementById('loading-overlay').classList.remove('active');
                document.getElementById('generate-btn').disabled = false;
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.classList.add('active');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            document.getElementById('error-message').classList.remove('active');
        }

        function showSuccess(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.add('active');
        }

        function hideSuccess() {
            document.getElementById('success-message').classList.remove('active');
        }

        // Initialize
        updateQuantityCalc();
    </script>
</body>
</html>
