<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin | CellarSense</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="icon" type="image/png" href="images/Updated_favicon.png">
    
    <style>
        :root {
            --burgundy: #722F37;
            --burgundy-dark: #5a252c;
            --burgundy-light: #8b3d47;
            --gold: #C9A962;
            --gold-light: #d4b978;
            --cream: #FAF8F5;
            --cream-dark: #EDE8E0;
            --text-dark: #2D2D2D;
            --text-medium: #5A5A5A;
            --text-light: #8A8A8A;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--cream-dark);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            height: 50px;
            width: auto;
        }

        .admin-badge {
            background: var(--burgundy);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content */
        .main {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            color: var(--burgundy);
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--text-medium);
            font-size: 1rem;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .card h3 {
            font-size: 1.25rem;
            color: var(--burgundy);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--cream-dark);
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--cream-dark);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--burgundy);
            box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        select.form-input {
            cursor: pointer;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--cream-dark);
            margin: 2rem 0;
        }

        /* Calculator Results */
        .calc-result {
            background: var(--cream);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .calc-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }

        .calc-item-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .calc-item-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--burgundy);
        }

        .calc-item-unit {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .calc-total {
            background: var(--burgundy);
            color: white;
        }

        .calc-total .calc-item-label {
            color: rgba(255,255,255,0.7);
        }

        .calc-total .calc-item-value {
            color: white;
        }

        .calc-total .calc-item-unit {
            color: rgba(255,255,255,0.8);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }

        .btn-primary {
            background: var(--burgundy);
            color: white;
        }

        .btn-primary:hover {
            background: var(--burgundy-dark);
        }

        .btn-secondary {
            background: var(--cream-dark);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #ddd;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--cream-dark);
            border-top-color: var(--burgundy);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Messages */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--cream-dark);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--burgundy);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
        }

        .modal-close:hover {
            color: var(--burgundy);
        }

        .preview-section {
            margin-bottom: 1.5rem;
        }

        .preview-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--burgundy);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-editable {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--cream-dark);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
        }

        .preview-editable:focus {
            outline: none;
            border-color: var(--burgundy);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--cream-dark);
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .logo {
                height: 40px;
            }

            .main {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="images/Horizontal_Burgundy.png" alt="CellarSense" class="logo">
        <span class="admin-badge">Admin</span>
    </header>

    <main class="main">
        <div class="section-header">
            <h1 class="section-title">Generate Client PDF</h1>
            <p class="section-subtitle">Create a personalized wedding wine guide for your client.</p>
        </div>

        <div class="card">
            <h3>Client Details</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Couple's Names</label>
                    <input type="text" class="form-input" id="pdf-names" placeholder="Sarah & Mike">
                </div>
                <div class="form-group">
                    <label class="form-label">Wedding Date</label>
                    <input type="date" class="form-input" id="pdf-date">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Venue Name</label>
                    <input type="text" class="form-input" id="pdf-venue" placeholder="The Estate at Sunset Bay">
                </div>
                <div class="form-group">
                    <label class="form-label">Venue Type</label>
                    <select class="form-input" id="pdf-venue-type">
                        <option value="ballroom">Ballroom / Hotel</option>
                        <option value="outdoor">Outdoor / Garden</option>
                        <option value="vineyard">Vineyard / Winery</option>
                        <option value="beach">Beach / Waterfront</option>
                        <option value="rustic">Barn / Rustic</option>
                        <option value="modern">Modern / Loft</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Guest Count</label>
                    <input type="number" class="form-input" id="pdf-guests" placeholder="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Event Duration (hours)</label>
                    <input type="number" class="form-input" id="pdf-hours" placeholder="5" value="5">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Total Wine Budget</label>
                    <input type="number" class="form-input" id="pdf-budget" placeholder="2000">
                </div>
                <div class="form-group">
                    <label class="form-label">Location (City, State)</label>
                    <input type="text" class="form-input" id="pdf-location" placeholder="St. Petersburg, FL">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Bar Setup</label>
                    <select class="form-input" id="pdf-bar-type">
                        <option value="wine-focus">Wine-focused (wine is primary drink)</option>
                        <option value="mixed">Mixed bar (beer, cocktails, and wine)</option>
                        <option value="wine-beer">Wine and beer only</option>
                        <option value="toast-only">Toast only (sparkling for toast, limited table wine)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Guest Drinking Level</label>
                    <select class="form-input" id="pdf-drinking-level">
                        <option value="moderate">Moderate (1-2 glasses per person)</option>
                        <option value="light">Light (0.5 glasses per person)</option>
                        <option value="heavy">Heavy (2-3 glasses per person)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Include Rosé?</label>
                    <select class="form-input" id="pdf-include-rose">
                        <option value="yes">Yes, include rosé</option>
                        <option value="no">No rosé needed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Red vs. White Balance</label>
                    <select class="form-input" id="pdf-red-white-balance">
                        <option value="balanced">Balanced (50/50)</option>
                        <option value="more-red">More red drinkers (60/40)</option>
                        <option value="more-white">More white drinkers (40/60)</option>
                        <option value="heavy-red">Mostly red (75/25)</option>
                        <option value="heavy-white">Mostly white (25/75)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Sparkling Wine Usage</label>
                    <select class="form-input" id="pdf-sparkling-usage">
                        <option value="toast-only">Toast only</option>
                        <option value="toast-and-bar">Toast + available at bar</option>
                        <option value="no-toast">Bar only (no formal toast)</option>
                    </select>
                </div>
            </div>

            <div class="divider"></div>

            <h3>Wedding Theme & Preferences</h3>

            <div class="form-group">
                <label class="form-label">Wedding Vibe / Theme</label>
                <input type="text" class="form-input" id="pdf-vibe" placeholder="e.g., Mediterranean coastal elegance">
            </div>

            <div class="form-group">
                <label class="form-label">Food Being Served</label>
                <textarea class="form-input" id="pdf-food" placeholder="e.g., Cocktail hour: passed apps (bruschetta, shrimp). Dinner: choice of beef tenderloin, grilled salmon, or mushroom risotto."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Client Preferences (from consultation)</label>
                <textarea class="form-input" id="pdf-preferences" placeholder="e.g., Bride loves rosé, groom prefers bold reds. Want to avoid oaky Chardonnay."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Special Notes</label>
                <textarea class="form-input" id="pdf-notes" placeholder="e.g., Grandmother is from Italy, would love to include an Italian wine."></textarea>
            </div>

            <div class="divider"></div>

            <h3>Quantity Calculator</h3>
            <div class="calc-result" id="calc-results">
                <p style="color: var(--text-medium); font-size: 0.9rem; text-align: center;">Enter guest count above to calculate quantities.</p>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="previewPDF()">Preview & Edit Guide</button>
                <button class="btn btn-secondary" onclick="generatePDF()">Generate PDF Directly</button>
            </div>

            <div id="pdf-status"></div>
        </div>
    </main>

    <footer class="footer">
        <p>CellarSense Admin Panel — Not for public access</p>
    </footer>

    <!-- Preview/Edit Modal -->
    <div class="modal-overlay" id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Preview & Edit Guide</h2>
                <button class="modal-close" onclick="closePreviewModal()">×</button>
            </div>
            
            <div class="preview-section">
                <div class="preview-section-title">Your Vision</div>
                <textarea class="preview-editable" id="preview-vision"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-section-title">Tailored For You</div>
                <textarea class="preview-editable" id="preview-personalization"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-section-title">Sparkling Wine Description</div>
                <textarea class="preview-editable" id="preview-sparkling"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-section-title">White Wine Description</div>
                <textarea class="preview-editable" id="preview-white"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-section-title">Red Wine Description</div>
                <textarea class="preview-editable" id="preview-red"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-section-title">Rosé Description</div>
                <textarea class="preview-editable" id="preview-rose"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePreviewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="generatePDFFromPreview()">Generate PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // WINE DATABASE
        // ============================================
        const wineDatabase = {
            red: [
                { name: "Cabernet Sauvignon", region: "Napa Valley, USA", type: "Red", notes: "Full-bodied with dark fruit, cedar, and vanilla. Firm tannins and long finish.", pairs: ["beef", "steak", "lamb", "hearty", "grilled", "bbq", "burger", "ribeye"], vibe: ["elegant", "classic", "modern"], priceRange: { "$": "~$14", "$$": "~$28", "$$$": "~$75" }, bottles: { "$": "Avalon Napa Cabernet", "$$": "Robert Mondavi Napa Cabernet", "$$$": "Caymus Cabernet Sauvignon" } },
                { name: "Pinot Noir", region: "Willamette Valley, USA", type: "Red", notes: "Elegant and silky with cherry, raspberry, and earthy undertones. Bright acidity.", pairs: ["salmon", "duck", "mushroom", "chicken", "turkey", "pork", "tuna"], vibe: ["elegant", "garden", "rustic"], priceRange: { "$": "~$14", "$$": "~$28", "$$$": "~$65" }, bottles: { "$": "Erath Oregon Pinot Noir", "$$": "Domaine Drouhin Oregon", "$$$": "Beaux Frères Willamette Valley" } },
                { name: "Pinot Noir", region: "Burgundy, France", type: "Red", notes: "Refined and complex with red fruit, earth, and subtle oak. Classic Old World elegance.", pairs: ["duck", "game", "mushroom", "chicken", "pork"], vibe: ["elegant", "classic", "romantic"], priceRange: { "$": "~$18", "$$": "~$28", "$$$": "~$48" }, bottles: { "$": "Louis Jadot Bourgogne", "$$": "Philippe Girard Savigny-les-Beaune", "$$$": "Domaine Faiveley Mercury" } },
                { name: "Malbec", region: "Mendoza, Argentina", type: "Red", notes: "Plush and velvety with blackberry, plum, and hints of cocoa and violet.", pairs: ["steak", "beef", "grilled", "bbq", "empanadas", "burger"], vibe: ["rustic", "modern", "festive"], priceRange: { "$": "~$10", "$$": "~$18", "$$$": "~$40" }, bottles: { "$": "Alamos Malbec", "$$": "Catena Malbec", "$$$": "Catena Alta Malbec" } },
                { name: "Sangiovese", region: "Tuscany, Italy", type: "Red", notes: "Bright cherry and plum with herbs, tobacco, and earthy notes. Vibrant acidity.", pairs: ["pasta", "pizza", "tomato", "italian", "lasagna", "osso buco"], vibe: ["mediterranean", "rustic", "elegant"], priceRange: { "$": "~$12", "$$": "~$24", "$$$": "~$52" }, bottles: { "$": "Ruffino Chianti", "$$": "Arceno Chianti Classico", "$$$": "Antinori Marchese Chianti Classico Riserva" } },
                { name: "Syrah / Shiraz", region: "Rhône Valley, France", type: "Red", notes: "Bold and peppery with dark fruit, smoke, and savory herbs. Full-bodied with structure.", pairs: ["lamb", "game", "grilled", "stews", "charcuterie", "bbq", "ribs"], vibe: ["rustic", "elegant", "modern"], priceRange: { "$": "~$14", "$$": "~$28", "$$$": "~$48" }, bottles: { "$": "E. Guigal Côtes du Rhône", "$$": "M. Chapoutier Crozes-Hermitage", "$$$": "Domaine Chante Cigale Châteauneuf-du-Pape" } },
                { name: "Barbera", region: "Piedmont, Italy", type: "Red", notes: "Bright and juicy with cherry, raspberry, and subtle spice. Low tannins, high acidity.", pairs: ["pizza", "pasta", "tomato", "vegetables", "salumi", "risotto"], vibe: ["rustic", "mediterranean", "festive"], priceRange: { "$": "~$12", "$$": "~$22", "$$$": "~$55" }, bottles: { "$": "Michele Chiarlo Barbera d'Asti", "$$": "Vietti Barbera d'Asti Tre Vigne", "$$$": "Braida Bricco dell'Uccellone" } },
                { name: "Rioja", region: "Spain", type: "Red", notes: "Elegant with red fruit, vanilla, leather, and tobacco from American oak aging.", pairs: ["lamb", "pork", "tapas", "manchego", "paella"], vibe: ["classic", "elegant", "mediterranean"], priceRange: { "$": "~$12", "$$": "~$22", "$$$": "~$45" }, bottles: { "$": "Marqués de Cáceres Crianza", "$$": "La Rioja Alta Viña Alberdi Reserva", "$$$": "López de Heredia Viña Tondonia Reserva" } }
            ],
            white: [
                { name: "Riesling", region: "Germany", type: "White", notes: "Aromatic with green apple, citrus, and petrol notes. Crisp acidity with mineral finish.", pairs: ["spicy", "asian", "thai", "indian", "seafood", "pork", "sushi"], vibe: ["garden", "modern", "elegant"], priceRange: { "$": "~$14", "$$": "~$22", "$$$": "~$49" }, bottles: { "$": "Dr. Loosen Blue Slate", "$$": "Carl Graff Riesling", "$$$": "Hofgut Falkenstein Riesling Kabinett" } },
                { name: "Chablis", region: "Burgundy, France", type: "White", notes: "Lean and mineral-driven with citrus, green apple, and flinty notes. Unoaked elegance.", pairs: ["oysters", "shellfish", "seafood", "sushi", "goat cheese", "fish"], vibe: ["elegant", "classic", "beach"], priceRange: { "$": "~$18", "$$": "~$24", "$$$": "~$40" }, bottles: { "$": "William Fèvre Petit Chablis", "$$": "J. Moreau & Fils Les Petits Dieux", "$$$": "Jean-Marc Brocard V.V. 1946 Chablis" } },
                { name: "Chenin Blanc", region: "Loire Valley, France", type: "White", notes: "Versatile with honey, apple, and floral notes. Balanced acidity with waxy texture.", pairs: ["poultry", "pork", "thai", "cheese", "fruit", "desserts"], vibe: ["garden", "elegant", "rustic"], priceRange: { "$": "~$12", "$$": "~$28", "$$$": "~$55" }, bottles: { "$": "Pine Ridge Chenin Blanc + Viognier", "$$": "Domaine Huet Vouvray Sec", "$$$": "Nicolas Joly Savennières" } },
                { name: "Chardonnay", region: "Burgundy, France", type: "White", notes: "Rich and buttery with apple, citrus, and vanilla. Elegant oak integration.", pairs: ["lobster", "crab", "chicken", "cream", "butter", "risotto"], vibe: ["elegant", "classic", "modern"], priceRange: { "$": "~$14", "$$": "~$27", "$$$": "~$35" }, bottles: { "$": "Louis Latour Mâcon-Lugny", "$$": "Louis Latour Grand Ardèche", "$$$": "Château Vitallis Pouilly-Fuissé" } },
                { name: "Sauvignon Blanc", region: "Marlborough, New Zealand", type: "White", notes: "Crisp and zesty with grapefruit, lime, and herbaceous notes. Refreshing acidity.", pairs: ["salad", "goat cheese", "seafood", "oysters", "fish", "sushi", "ceviche"], vibe: ["garden", "beach", "modern"], priceRange: { "$": "~$14", "$$": "~$28", "$$$": "~$40" }, bottles: { "$": "Kim Crawford Sauvignon Blanc", "$$": "Cloudy Bay Sauvignon Blanc", "$$$": "Dog Point Section 94" } },
                { name: "Pinot Grigio", region: "Alto Adige, Italy", type: "White", notes: "Light and refreshing with pear, apple, and citrus. Clean and crisp finish.", pairs: ["appetizers", "salads", "fish", "shrimp", "pasta"], vibe: ["garden", "beach", "mediterranean"], priceRange: { "$": "~$20", "$$": "~$22", "$$$": "~$35" }, bottles: { "$": "Santa Margherita Pinot Grigio", "$$": "Alois Lageder Pinot Grigio", "$$$": "Elena Walch Castel Ringberg" } },
                { name: "Albariño", region: "Rías Baixas, Spain", type: "White", notes: "Bright and mineral with citrus, stone fruit, and saline notes. Ocean influence.", pairs: ["seafood", "oysters", "shrimp", "fish", "tapas", "ceviche"], vibe: ["beach", "mediterranean", "modern"], priceRange: { "$": "~$12", "$$": "~$15", "$$$": "~$45" }, bottles: { "$": "Martín Códax Albariño", "$$": "Burgans Albariño", "$$$": "Pazo de Señorans Selección de Añada" } }
            ],
            rose: [
                { name: "Provence Rosé", region: "Provence, France", type: "Rosé", notes: "Pale and elegant with strawberry, peach, and herbs. Dry and refreshing.", pairs: ["salads", "seafood", "light", "appetizers", "chicken", "mediterranean"], vibe: ["garden", "beach", "mediterranean", "elegant"], priceRange: { "$": "~$18", "$$": "~$22", "$$$": "~$68" }, bottles: { "$": "AIX Rosé", "$$": "Whispering Angel Rosé", "$$$": "Domaine Tempier Bandol" } }
            ],
            sparkling: [
                { name: "California Sparkling", region: "California, USA", type: "Sparkling", notes: "Fresh and fruity with green apple, citrus, and toast. Fine persistent bubbles.", pairs: ["appetizers", "brunch", "celebrations", "oysters", "light"], vibe: ["modern", "festive", "elegant"], priceRange: { "$": "~$15", "$$": "~$25", "$$$": "~$40" }, bottles: { "$": "Gruet Brut", "$$": "Schramsberg Mirabelle Brut", "$$$": "Schramsberg Blanc de Blancs" } },
                { name: "Rosé Bubbles", region: "Champagne, France", type: "Sparkling", notes: "Delicate pink with strawberry, raspberry, and brioche notes. Celebratory elegance.", pairs: ["celebrations", "brunch", "appetizers", "strawberries", "desserts"], vibe: ["romantic", "elegant", "festive"], priceRange: { "$": "~$12", "$$": "~$30", "$$$": "~$90" }, bottles: { "$": "Segura Viudas Brut Rosé", "$$": "Domaine Franck Besson Granit", "$$$": "Billecart-Salmon Brut Rosé" } },
                { name: "Champagne", region: "Champagne, France", type: "Sparkling", notes: "Elegant bubbles with brioche, apple, and citrus. Toasty and complex.", pairs: ["oysters", "caviar", "appetizers", "celebrations", "seafood"], vibe: ["elegant", "classic", "modern", "festive"], priceRange: { "$": "~$35", "$$": "~$39", "$$$": "~$65" }, bottles: { "$": "Nicolas Feuillatte Brut", "$$": "Marcel Pierre Brut", "$$$": "Taittinger Brut Réserve" } },
                { name: "Prosecco", region: "Italy", type: "Sparkling", notes: "Light and fruity with green apple, pear, and floral notes. Fresh and approachable.", pairs: ["appetizers", "brunch", "light", "celebrations", "aperitivo"], vibe: ["garden", "beach", "modern", "festive"], priceRange: { "$": "~$14", "$$": "~$18", "$$$": "~$25" }, bottles: { "$": "La Marca Prosecco", "$$": "Bisol Jeio Prosecco", "$$$": "Nino Franco Primo Franco" } },
                { name: "Cava", region: "Spain", type: "Sparkling", notes: "Crisp and citrusy with apple and almond notes. Excellent value bubbles.", pairs: ["tapas", "appetizers", "seafood", "brunch", "celebrations"], vibe: ["mediterranean", "festive", "modern"], priceRange: { "$": "~$10", "$$": "~$18", "$$$": "~$35" }, bottles: { "$": "Freixenet Cordon Negro", "$$": "Segura Viudas Reserva Heredad", "$$$": "Gramona Imperial" } }
            ]
        };

        // ============================================
        // QUANTITY CALCULATOR
        // ============================================
        function calculateWineQuantities(guests, hours, barType, drinkingLevel, includeRose, redWhiteBalance, sparklingUsage) {
            let drinksPerGuest = 0.5;
            if (drinkingLevel === 'light') drinksPerGuest = 0.3;
            if (drinkingLevel === 'heavy') drinksPerGuest = 0.7;

            let barMultiplier = 1.0;
            if (barType === 'mixed') barMultiplier = 0.5;
            if (barType === 'wine-beer') barMultiplier = 0.7;
            if (barType === 'toast-only') barMultiplier = 0.2;

            const totalDrinks = guests * (drinksPerGuest + (hours - 4) * 0.15) * barMultiplier;
            let totalBottles = Math.ceil(totalDrinks);

            // Sparkling calculation
            let sparklingBottles = Math.ceil(guests / 6);
            if (sparklingUsage === 'toast-and-bar') sparklingBottles = Math.ceil(guests / 4);
            if (sparklingUsage === 'no-toast') sparklingBottles = Math.ceil(guests / 8);

            const remainingBottles = Math.max(0, totalBottles - sparklingBottles);

            // Red/White balance
            let redRatio = 0.5, whiteRatio = 0.5;
            if (redWhiteBalance === 'more-red') { redRatio = 0.6; whiteRatio = 0.4; }
            if (redWhiteBalance === 'more-white') { redRatio = 0.4; whiteRatio = 0.6; }
            if (redWhiteBalance === 'heavy-red') { redRatio = 0.75; whiteRatio = 0.25; }
            if (redWhiteBalance === 'heavy-white') { redRatio = 0.25; whiteRatio = 0.75; }

            // Rosé adjustment
            let roseBottles = 0;
            if (includeRose === 'yes') {
                roseBottles = Math.ceil(remainingBottles * 0.15);
            }

            const stillWineBottles = remainingBottles - roseBottles;
            const redBottles = Math.ceil(stillWineBottles * redRatio);
            const whiteBottles = Math.ceil(stillWineBottles * whiteRatio);

            return {
                sparklingBottles,
                whiteBottles,
                redBottles,
                roseBottles,
                totalBottles: sparklingBottles + whiteBottles + redBottles + roseBottles
            };
        }

        function updateQuantityCalc() {
            const guests = parseInt(document.getElementById('pdf-guests')?.value) || 0;
            const hours = parseInt(document.getElementById('pdf-hours')?.value) || 5;
            const budget = parseFloat(document.getElementById('pdf-budget')?.value) || 0;
            const barType = document.getElementById('pdf-bar-type')?.value || 'mixed';
            const drinkingLevel = document.getElementById('pdf-drinking-level')?.value || 'moderate';
            const includeRose = document.getElementById('pdf-include-rose')?.value || 'yes';
            const redWhiteBalance = document.getElementById('pdf-red-white-balance')?.value || 'balanced';
            const sparklingUsage = document.getElementById('pdf-sparkling-usage')?.value || 'toast-only';

            if (guests === 0) {
                document.getElementById('calc-results').innerHTML = `
                    <p style="color: var(--text-medium); font-size: 0.9rem; text-align: center;">Enter guest count above to calculate quantities.</p>
                `;
                return;
            }

            const calc = calculateWineQuantities(guests, hours, barType, drinkingLevel, includeRose, redWhiteBalance, sparklingUsage);
            const avgPrice = budget > 0 ? (budget / calc.totalBottles).toFixed(0) : '—';

            document.getElementById('calc-results').innerHTML = `
                <div class="calc-grid">
                    <div class="calc-item">
                        <div class="calc-item-label">Sparkling</div>
                        <div class="calc-item-value">${calc.sparklingBottles}</div>
                        <div class="calc-item-unit">bottles</div>
                    </div>
                    <div class="calc-item">
                        <div class="calc-item-label">White</div>
                        <div class="calc-item-value">${calc.whiteBottles}</div>
                        <div class="calc-item-unit">bottles</div>
                    </div>
                    <div class="calc-item">
                        <div class="calc-item-label">Red</div>
                        <div class="calc-item-value">${calc.redBottles}</div>
                        <div class="calc-item-unit">bottles</div>
                    </div>
                    <div class="calc-item">
                        <div class="calc-item-label">Rosé</div>
                        <div class="calc-item-value">${calc.roseBottles}</div>
                        <div class="calc-item-unit">bottles</div>
                    </div>
                    <div class="calc-item calc-total">
                        <div class="calc-item-label">Total</div>
                        <div class="calc-item-value">${calc.totalBottles}</div>
                        <div class="calc-item-unit">~$${avgPrice}/bottle</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // NARRATIVE GENERATORS
        // ============================================
        function expandVision(vibe, venueType, venue) {
            const vibeDescriptions = {
                'elegant': 'timeless sophistication with refined details',
                'rustic': 'warm, natural charm with organic textures',
                'modern': 'sleek contemporary style with clean lines',
                'garden': 'lush greenery and romantic florals',
                'beach': 'relaxed coastal elegance with ocean breezes',
                'mediterranean': 'sun-drenched warmth with Old World charm',
                'romantic': 'soft, dreamy atmosphere with intimate touches',
                'classic': 'enduring beauty with traditional grace'
            };

            const venueDescriptions = {
                'ballroom': 'grand spaces and crystal chandeliers',
                'outdoor': 'open skies and natural beauty',
                'vineyard': 'rolling vines and wine country magic',
                'beach': 'sandy shores and sunset views',
                'rustic': 'weathered wood and cozy ambiance',
                'modern': 'architectural drama and urban sophistication'
            };

            let description = `Your celebration at ${venue || 'your venue'} embraces `;
            
            const vibeLower = (vibe || '').toLowerCase();
            let matchedVibe = null;
            for (const key in vibeDescriptions) {
                if (vibeLower.includes(key)) {
                    matchedVibe = vibeDescriptions[key];
                    break;
                }
            }
            
            description += matchedVibe || vibe || 'a beautiful atmosphere';
            description += `, complemented by ${venueDescriptions[venueType] || 'stunning surroundings'}. `;
            description += `Every wine has been chosen to enhance this vision and create moments your guests will remember.`;

            return description;
        }

        function synthesizePersonalization(preferences, notes, names) {
            if (!preferences && !notes) {
                return `These selections have been curated specifically for ${names}'s celebration, balancing crowd-pleasing favorites with thoughtful choices that reflect your unique style.`;
            }

            let personalization = `For ${names}, we've crafted selections that honor your preferences: `;
            
            if (preferences) {
                personalization += preferences.replace(/\.$/, '') + '. ';
            }
            
            if (notes) {
                personalization += notes.replace(/\.$/, '') + '. ';
            }

            personalization += `Each bottle tells part of your story.`;

            return personalization;
        }

        function getWineNarrative(category, wineName) {
            const narratives = {
                'Sparkling': {
                    'Champagne': 'The gold standard for celebration. Nothing announces a momentous occasion quite like true Champagne.',
                    'Prosecco': 'Fresh, festive, and irresistibly approachable. Perfect for keeping the energy high all evening.',
                    'Cava': 'Spain\'s answer to Champagne. Crisp elegance at remarkable value.',
                    'California Sparkling': 'New World craftsmanship meets Old World tradition. Consistently impressive.',
                    'Rosé Bubbles': 'Romantic pink bubbles that photograph beautifully and taste even better.'
                },
                'White': {
                    'Chardonnay': 'A crowd-pleaser that balances richness with freshness—versatile for diverse palates.',
                    'Sauvignon Blanc': 'Crisp, refreshing, and utterly food-friendly. Guests reach for this all evening.',
                    'Pinot Grigio': 'Clean and approachable—the definition of easy-drinking elegance.',
                    'Albariño': 'Mineral-driven freshness with subtle salinity. Incredibly food-friendly.',
                    'Riesling': 'Aromatic and versatile, with just enough sweetness to please everyone.',
                    'Chablis': 'Pure, mineral-driven elegance. Unoaked Chardonnay at its finest.',
                    'Chenin Blanc': 'Honeyed notes meet bright acidity. A sommelier favorite.'
                },
                'Red': {
                    'Cabernet Sauvignon': 'The classic choice—structured and sophisticated, universally respected.',
                    'Pinot Noir': 'Elegant and versatile, bridging red and white wine drinkers beautifully.',
                    'Malbec': 'Plush, friendly, and crowd-pleasing with smooth tannins.',
                    'Sangiovese': 'Italy\'s noble grape—bright cherry fruit made for food and celebration.',
                    'Syrah / Shiraz': 'Bold and peppery with incredible depth. A statement red.',
                    'Barbera': 'Bright, juicy, and impossibly food-friendly. Italy\'s secret weapon.',
                    'Rioja': 'Elegant Spanish red with vanilla and leather notes from oak aging.'
                },
                'Rosé': {
                    'Provence Rosé': 'The gold standard—pale, elegant, impossibly refreshing. Tastes even better than it looks.'
                }
            };
            return narratives[category]?.[wineName] || 'A thoughtfully selected wine to complement your celebration.';
        }

        function getBarTypeLabel(barType) {
            const labels = {
                'wine-focus': 'wine-focused bar',
                'mixed': 'full bar with wine',
                'wine-beer': 'wine and beer bar',
                'toast-only': 'toast service'
            };
            return labels[barType] || 'standard service';
        }

        function getWhereToBuy(location) {
            const locationLower = location.toLowerCase();
            const stores = [
                { name: 'Total Wine & More', address: 'Multiple locations', url: 'https://www.totalwine.com/store-finder', note: 'Best selection, 10-15% case discounts' },
                { name: 'Costco', address: 'Membership required', url: 'https://www.costco.com/warehouse-locations', note: 'Exceptional value, Kirkland wines are gems' },
                { name: 'Wine.com', address: 'Online with delivery', url: 'https://www.wine.com', note: 'Wide selection, easy ordering' }
            ];

            if (locationLower.includes('st. pete') || locationLower.includes('tampa') || locationLower.includes('petersburg')) {
                stores.unshift({ name: 'Fortunato Wine', address: '251 2nd Ave N, St. Petersburg, FL', url: 'https://fortunatowine.com', note: 'Local favorite, knowledgeable staff' });
            }
            return stores;
        }

        // Store API recommendations globally
        let apiRecommendations = null;
        let apiNarratives = null;

        async function getVibeBasedRecommendations(vibe, food, avgPrice, notes, preferences) {
            let tier = avgPrice >= 25 ? '$$$' : avgPrice >= 15 ? '$$' : '$';
            const budgetLabel = tier === '$$$' ? '$30+' : tier === '$$' ? '$15-30' : 'Under $15';
            
            // Build context for wedding wine recommendation
            const weddingContext = `Wedding wine selection for: ${vibe || 'elegant celebration'}. 
Menu: ${food || 'wedding dinner'}. 
Client preferences: ${preferences || 'none specified'}. 
Special notes: ${notes || 'none'}.
Budget per bottle: ${budgetLabel} (~$${avgPrice} average).
Need recommendations for: Sparkling (toast), White, Red, and Rosé.`;

            try {
                const response = await fetch('/api/wine-recommendation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dish: weddingContext,
                        preferences: `Wedding event. ${preferences || ''} ${notes || ''}`.trim(),
                        budget: tier
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Store narratives from API for use in preview
                apiNarratives = {};
                
                // Parse API response into our format
                const recommendations = [];
                const categoryMap = {
                    'sparkling': 'Sparkling',
                    'white': 'White', 
                    'red': 'Red',
                    'rosé': 'Rosé',
                    'rose': 'Rosé'
                };

                // Try to extract 4 wines (sparkling, white, red, rosé)
                if (data.wines && data.wines.length > 0) {
                    data.wines.forEach(wine => {
                        const typeKey = wine.type.toLowerCase();
                        const category = categoryMap[typeKey] || wine.type;
                        
                        recommendations.push({
                            category: category,
                            name: wine.name,
                            region: wine.region,
                            bottle: wine.bottle,
                            price: wine.price.replace(/[~$]/g, ''),
                            why: wine.why
                        });

                        // Store narrative
                        apiNarratives[category.toLowerCase()] = wine.why;
                    });
                }

                // Ensure we have all 4 categories, fill with defaults if needed
                const categories = ['Sparkling', 'White', 'Red', 'Rosé'];
                categories.forEach(cat => {
                    if (!recommendations.find(r => r.category === cat)) {
                        const fallback = getFallbackWine(cat, tier);
                        recommendations.push(fallback);
                        apiNarratives[cat.toLowerCase()] = getWineNarrative(cat, fallback.name);
                    }
                });

                // Sort to ensure correct order
                const sortOrder = { 'Sparkling': 0, 'White': 1, 'Red': 2, 'Rosé': 3 };
                recommendations.sort((a, b) => sortOrder[a.category] - sortOrder[b.category]);

                apiRecommendations = recommendations;
                return recommendations;

            } catch (error) {
                console.error('API Error, using fallback:', error);
                return getFallbackRecommendations(tier);
            }
        }

        function getFallbackWine(category, tier) {
            const fallbacks = {
                'Sparkling': wineDatabase.sparkling.find(w => w.name === 'Champagne') || wineDatabase.sparkling[0],
                'White': wineDatabase.white.find(w => w.name === 'Chardonnay') || wineDatabase.white[0],
                'Red': wineDatabase.red.find(w => w.name === 'Cabernet Sauvignon') || wineDatabase.red[0],
                'Rosé': wineDatabase.rose[0]
            };
            const wine = fallbacks[category];
            return {
                category: category,
                name: wine.name,
                region: wine.region,
                bottle: wine.bottles[tier],
                price: wine.priceRange[tier].replace(/[~$]/g, '')
            };
        }

        function getFallbackRecommendations(tier) {
            apiNarratives = {
                sparkling: getWineNarrative('Sparkling', 'Champagne'),
                white: getWineNarrative('White', 'Chardonnay'),
                red: getWineNarrative('Red', 'Cabernet Sauvignon'),
                rosé: getWineNarrative('Rosé', 'Provence Rosé')
            };
            return [
                getFallbackWine('Sparkling', tier),
                getFallbackWine('White', tier),
                getFallbackWine('Red', tier),
                getFallbackWine('Rosé', tier)
            ];
        }

        // ============================================
        // PREVIEW MODAL
        // ============================================
        let previewData = {};

        function gatherFormData() {
            return {
                names: document.getElementById('pdf-names').value || 'Client',
                date: document.getElementById('pdf-date').value,
                venue: document.getElementById('pdf-venue').value || 'Wedding Venue',
                venueType: document.getElementById('pdf-venue-type').value,
                guests: parseInt(document.getElementById('pdf-guests').value) || 100,
                hours: parseInt(document.getElementById('pdf-hours').value) || 5,
                budget: parseFloat(document.getElementById('pdf-budget').value) || 2000,
                location: document.getElementById('pdf-location').value || 'Your City',
                vibe: document.getElementById('pdf-vibe').value || 'Elegant celebration',
                food: document.getElementById('pdf-food').value || 'Wedding dinner',
                preferences: document.getElementById('pdf-preferences').value || '',
                notes: document.getElementById('pdf-notes').value || '',
                barType: document.getElementById('pdf-bar-type').value || 'mixed',
                drinkingLevel: document.getElementById('pdf-drinking-level').value || 'moderate',
                includeRose: document.getElementById('pdf-include-rose').value || 'yes',
                redWhiteBalance: document.getElementById('pdf-red-white-balance').value || 'balanced',
                sparklingUsage: document.getElementById('pdf-sparkling-usage').value || 'toast-only'
            };
        }

        async function previewPDF() {
            // Show loading state
            document.getElementById('pdf-status').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 1rem; color: var(--text-medium);">Getting AI recommendations...</p></div>';
            
            try {
                const data = gatherFormData();
                const calc = calculateWineQuantities(data.guests, data.hours, data.barType, data.drinkingLevel, data.includeRose, data.redWhiteBalance, data.sparklingUsage);
                const avgPrice = (data.budget / Math.max(1, calc.totalBottles)).toFixed(2);
                const recommendations = await getVibeBasedRecommendations(data.vibe, data.food, avgPrice, data.notes, data.preferences);

                previewData = { data, calc, avgPrice, recommendations };

                document.getElementById('preview-vision').value = expandVision(data.vibe, data.venueType, data.venue);
                document.getElementById('preview-personalization').value = synthesizePersonalization(data.preferences, data.notes, data.names);
                
                // Use API narratives if available, otherwise fall back to defaults
                document.getElementById('preview-sparkling').value = apiNarratives?.sparkling || getWineNarrative('Sparkling', recommendations[0].name);
                document.getElementById('preview-white').value = apiNarratives?.white || getWineNarrative('White', recommendations[1].name);
                document.getElementById('preview-red').value = apiNarratives?.red || getWineNarrative('Red', recommendations[2].name);
                document.getElementById('preview-rose').value = apiNarratives?.['rosé'] || apiNarratives?.rose || getWineNarrative('Rosé', recommendations[3].name);

                document.getElementById('pdf-status').innerHTML = '';
                document.getElementById('preview-modal').classList.add('active');
            } catch (error) {
                document.getElementById('pdf-status').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').classList.remove('active');
        }

        // ============================================
        // PDF GENERATION
        // ============================================
        function generatePDFFromPreview() {
            const editedVision = document.getElementById('preview-vision').value;
            const editedPersonalization = document.getElementById('preview-personalization').value;
            const editedNarratives = {
                sparkling: document.getElementById('preview-sparkling').value,
                white: document.getElementById('preview-white').value,
                red: document.getElementById('preview-red').value,
                rose: document.getElementById('preview-rose').value
            };
            closePreviewModal();
            buildPDF(previewData.data, previewData.calc, previewData.avgPrice, previewData.recommendations, editedVision, editedPersonalization, editedNarratives);
        }

        async function generatePDF() {
            // Show loading state
            document.getElementById('pdf-status').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 1rem; color: var(--text-medium);">Getting AI recommendations...</p></div>';
            
            try {
                const data = gatherFormData();
                const calc = calculateWineQuantities(data.guests, data.hours, data.barType, data.drinkingLevel, data.includeRose, data.redWhiteBalance, data.sparklingUsage);
                const avgPrice = (data.budget / Math.max(1, calc.totalBottles)).toFixed(2);
                const recommendations = await getVibeBasedRecommendations(data.vibe, data.food, avgPrice, data.notes, data.preferences);

                const vision = expandVision(data.vibe, data.venueType, data.venue);
                const personalization = synthesizePersonalization(data.preferences, data.notes, data.names);
                const narratives = {
                    sparkling: apiNarratives?.sparkling || getWineNarrative('Sparkling', recommendations[0].name),
                    white: apiNarratives?.white || getWineNarrative('White', recommendations[1].name),
                    red: apiNarratives?.red || getWineNarrative('Red', recommendations[2].name),
                    rose: apiNarratives?.['rosé'] || apiNarratives?.rose || getWineNarrative('Rosé', recommendations[3].name)
                };

                document.getElementById('pdf-status').innerHTML = '';
                buildPDF(data, calc, avgPrice, recommendations, vision, personalization, narratives);
            } catch (error) {
                document.getElementById('pdf-status').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function buildPDF(data, calc, avgPrice, recommendations, vision, personalization, narratives) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // PAGE 1: COVER
                doc.setFillColor(114, 47, 55); // burgundy
                doc.rect(0, 0, 210, 297, 'F');
                
                doc.setDrawColor(201, 162, 39); // gold
                doc.setLineWidth(0.5);
                doc.line(20, 20, 190, 20);

                doc.setTextColor(255, 255, 255); // white
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('WEDDING WINE GUIDE', 105, 120, { align: 'center' });

                doc.setDrawColor(201, 162, 39);
                doc.line(70, 130, 140, 130);

                doc.setFontSize(18);
                doc.setFont('helvetica', 'normal');
                doc.text('Curated for ' + data.names, 105, 150, { align: 'center' });

                const formattedDate = data.date ? new Date(data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
                if (formattedDate) {
                    doc.setFontSize(12);
                    doc.text(formattedDate, 105, 165, { align: 'center' });
                }
                doc.text(data.venue, 105, 180, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(201, 162, 39); // gold
                doc.text('CELLARSENSE.AI', 105, 270, { align: 'center' });

                // PAGE 2: VISION & QUANTITIES
                doc.addPage();
                var y = 30;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(114, 47, 55); // burgundy
                doc.text('YOUR VISION', 20, y);
                y += 10;

                doc.setFillColor(250, 247, 244); // cream
                doc.rect(15, y, 180, 50, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(26, 26, 46); // darkText
                var visionLines = doc.splitTextToSize(vision, 170);
                doc.text(visionLines, 20, y + 10);
                y += 60;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(114, 47, 55);
                doc.text('WINE QUANTITIES', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(90, 90, 110); // grayText
                doc.text('For ' + data.guests + ' guests over ' + data.hours + ' hours (' + getBarTypeLabel(data.barType) + '):', 20, y);
                y += 10;

                // Quantities list
                doc.setTextColor(90, 90, 110);
                doc.text('Sparkling (Toast)', 25, y);
                doc.text(calc.sparklingBottles + ' bottles', 100, y);
                y += 7;

                doc.text('White Wine', 25, y);
                doc.text(calc.whiteBottles + ' bottles', 100, y);
                y += 7;

                doc.text('Red Wine', 25, y);
                doc.text(calc.redBottles + ' bottles', 100, y);
                y += 7;

                doc.text('Rosé', 25, y);
                doc.text(calc.roseBottles + ' bottles', 100, y);
                y += 7;

                doc.setTextColor(114, 47, 55);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL', 25, y);
                doc.text(calc.totalBottles + ' bottles', 100, y);
                y += 10;

                doc.setTextColor(26, 26, 46);
                doc.setFont('helvetica', 'normal');
                doc.text('Budget: $' + data.budget.toLocaleString() + ' (~$' + avgPrice + '/bottle)', 20, y);

                // PAGE 3: RECOMMENDATIONS
                doc.addPage();
                y = 30;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(114, 47, 55);
                doc.text('OUR RECOMMENDATIONS', 20, y);
                y += 15;

                var wineNarratives = [narratives.sparkling, narratives.white, narratives.red, narratives.rose];
                
                for (var i = 0; i < recommendations.length; i++) {
                    var wine = recommendations[i];
                    
                    doc.setFillColor(250, 247, 244);
                    doc.rect(15, y, 180, 40, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(114, 47, 55);
                    doc.text(wine.category.toUpperCase(), 20, y + 8);
                    
                    doc.setFontSize(11);
                    doc.setTextColor(26, 26, 46);
                    doc.text(wine.name + ' — ' + wine.region, 20, y + 16);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(90, 90, 110);
                    var wineNarrative = doc.splitTextToSize(wineNarratives[i], 140);
                    doc.text(wineNarrative.slice(0, 2), 20, y + 24);
                    
                    doc.setTextColor(26, 26, 46);
                    doc.text('Our pick: ' + wine.bottle + ' (~$' + wine.price + ')', 20, y + 35);
                    
                    y += 48;
                }

                // PAGE 4: PERSONALIZATION & WHERE TO BUY
                doc.addPage();
                y = 30;

                if (personalization && personalization.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(114, 47, 55);
                    doc.text('TAILORED FOR YOU', 20, y);
                    y += 10;

                    doc.setFillColor(250, 247, 244);
                    doc.rect(15, y, 180, 35, 'F');
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(26, 26, 46);
                    var persLines = doc.splitTextToSize(personalization, 170);
                    doc.text(persLines, 20, y + 10);
                    y += 50;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(114, 47, 55);
                doc.text('WHERE TO BUY', 20, y);
                y += 10;

                var stores = getWhereToBuy(data.location);
                for (var j = 0; j < stores.length; j++) {
                    var store = stores[j];
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(26, 26, 46);
                    doc.text(store.name, 20, y);
                    y += 5;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(90, 90, 110);
                    doc.text(store.address, 20, y);
                    y += 5;
                    doc.setTextColor(114, 47, 55);
                    doc.text(store.url, 20, y);
                    y += 4;
                    doc.setTextColor(90, 90, 110);
                    doc.text(store.note, 20, y);
                    y += 10;
                }

                // PRO TIPS
                y += 5;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(114, 47, 55);
                doc.text('PRO TIPS', 20, y);
                y += 10;

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(90, 90, 110);
                doc.text('• Order 10-15% extra for spillage and enthusiastic guests.', 20, y);
                y += 6;
                doc.text('• Most retailers accept returns on unopened bottles.', 20, y);
                y += 6;
                doc.text('• Chill whites and rosé 2-3 hours before; reds 15-20 minutes.', 20, y);
                y += 6;
                doc.text('• Plan for 1 bartender per 50 guests.', 20, y);

                // Footer
                doc.setFillColor(114, 47, 55);
                doc.rect(0, 280, 210, 17, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('CellarSense.ai | anthony@cellarsense.ai', 105, 290, { align: 'center' });

                // Save
                var filename = data.names.replace(/[^a-z0-9]/gi, '_') + '_Wine_Guide.pdf';
                doc.save(filename);

                document.getElementById('pdf-status').innerHTML = '<div class="success-message">✓ PDF generated! Check your downloads.</div>';
                setTimeout(function() { document.getElementById('pdf-status').innerHTML = ''; }, 5000);
            } catch (error) {
                document.getElementById('pdf-status').innerHTML = '<div class="error-message">PDF Error: ' + error.message + '</div>';
                console.error('PDF Generation Error:', error);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Attach listeners for quantity calculator updates
            ['pdf-guests', 'pdf-hours', 'pdf-budget', 'pdf-bar-type', 'pdf-drinking-level', 'pdf-include-rose', 'pdf-red-white-balance', 'pdf-sparkling-usage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updateQuantityCalc);
                    el.addEventListener('input', updateQuantityCalc);
                }
            });
        });
    </script>
</body>
</html>
